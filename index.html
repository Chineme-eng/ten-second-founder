<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Picao AI: Founder Simulator [Infinite Edition]</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- CORE THEME --- */
        :root {
            --bg-color: #FDFBF7;
            --card-bg: #FFFFFF;
            --sidebar-bg: #F8FAFC;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --border: #E2E8F0;
            --accent: #4F46E5;
            --accent-dim: rgba(79, 70, 229, 0.05);
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --font-serif: 'Lora', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            font-family: var(--font-sans);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- FX CLASSES --- */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        .flash-red { animation: flashRed 0.5s; }
        @keyframes flashRed { 0% { background-color: rgba(239, 68, 68, 0.2); } 100% { background-color: transparent; } }
        
        .flash-green { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background-color: rgba(16, 185, 129, 0.2); } 100% { background-color: transparent; } }

        /* --- LAYOUT --- */
        .back-home {
            position: fixed; top: 24px; left: 24px; z-index: 2000;
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text-muted); padding: 10px 20px; border-radius: 99px;
            text-decoration: none; font-size: 0.8rem; font-weight: 500;
            transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .back-home:hover { color: var(--accent); border-color: var(--accent); transform: translateY(-1px); }

        #app-container {
            width: 100%; max-width: 1200px; height: 90vh;
            display: flex; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: 24px;
            box-shadow: var(--shadow-float); overflow: hidden;
            position: relative; opacity: 0; transform: scale(0.98);
            transition: opacity 0.6s ease, transform 0.6s ease; z-index: 10;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px; background: var(--sidebar-bg);
            border-right: 1px solid var(--border); padding: 32px;
            display: flex; flex-direction: column; gap: 24px; flex-shrink: 0;
        }
        .brand-header { font-family: var(--font-serif); font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; }
        
        .stat-group { display: flex; flex-direction: column; gap: 6px; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .stat-value { font-family: var(--font-mono); font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .stat-value.danger { color: var(--danger); }
        
        .bar-wrap { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s ease; border-radius: 99px; }

        .trait-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: auto; }
        .trait-badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid var(--border); color: var(--text-muted); font-weight: 600; }

        /* --- MAIN VIEW --- */
        .main-view { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        #story-log { flex-grow: 1; padding: 60px; padding-bottom: 120px; overflow-y: auto; scroll-behavior: smooth; display: flex; flex-direction: column; gap: 40px; }

        /* --- NODES --- */
        .story-node { animation: slideIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; max-width: 700px; margin: 0 auto; width: 100%; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .node-header { font-family: var(--font-mono); color: var(--accent); font-size: 0.7rem; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; opacity: 0.8; }
        .node-line { height: 1px; flex-grow: 1; background: var(--border); }
        .node-text { font-size: 1.1rem; line-height: 1.7; color: var(--text-main); margin-bottom: 25px; white-space: pre-wrap; font-family: var(--font-sans); }
        .node-text b { font-weight: 700; color: var(--text-main); }

        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .choice-grid.single { grid-template-columns: 1fr; }
        
        .choice-btn {
            background: white; border: 1px solid var(--border); color: var(--text-main);
            padding: 20px; border-radius: 12px; text-align: left; cursor: pointer;
            transition: all 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; gap: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .choice-btn:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1); }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .choice-title { font-weight: 600; font-size: 0.9rem; }
        .choice-meta { font-size: 0.7rem; color: var(--text-muted); font-family: var(--font-mono); }

        /* --- START SCREEN --- */
        #start-screen { position: fixed; inset: 0; background: var(--bg-color); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.8s cubic-bezier(0.8, 0, 0.2, 1); }
        .orb { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(120px); opacity: 0.1; z-index: 1; pointer-events: none; }
        .orb-1 { background: #4F46E5; top: -10%; left: -10%; animation: float 10s infinite alternate; }
        .orb-2 { background: #9333EA; bottom: -10%; right: -10%; animation: float 12s infinite alternate-reverse; }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(50px, 50px); } }

        .logo-box { position: relative; z-index: 2; text-align: center; max-width: 500px; animation: fadeIn 1s ease-out; }
        h1 { font-family: var(--font-serif); font-size: 3.5rem; margin: 0 0 20px 0; color: var(--text-main); font-style: italic; font-weight: 600; letter-spacing: -2px; }
        h1 span { color: var(--accent); }
        .subtitle { color: var(--text-muted); margin-bottom: 40px; font-size: 1rem; line-height: 1.6; }
        
        .start-btn {
            background: var(--text-main); color: white; border: none; padding: 18px 50px;
            font-size: 0.9rem; border-radius: 99px; font-weight: 600; cursor: pointer;
            transition: 0.3s; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .start-btn:hover { transform: scale(1.05); background: var(--accent); }

        /* --- POPUPS --- */
        .floaty { position: absolute; font-weight: bold; font-family: var(--font-mono); pointer-events: none; animation: floatUp 1.5s forwards; z-index: 9999; font-size: 1rem; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(10px); } 20% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; height: 100vh; border-radius: 0; border: none; }
            .sidebar { width: 100%; padding: 20px; border-right: none; border-bottom: 1px solid var(--border); flex-direction: row; flex-wrap: wrap; gap: 15px; align-items: center; max-height: 160px; overflow-y: auto; }
            .sidebar .trait-list { display: none; }
            .choice-grid { grid-template-columns: 1fr; }
            #story-log { padding: 24px; padding-bottom: 80px; }
            h1 { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

<a href="https://www.picaoai.com" class="back-home">
    <i data-lucide="arrow-left" style="width: 14px;"></i> Return to Picao
</a>

<div id="start-screen">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="logo-box">
        <div style="font-family: var(--font-mono); color: var(--accent); margin-bottom: 15px; font-size: 0.75rem; letter-spacing: 2px;">SIMULATION v3.0 // INFINITE</div>
        <h1>Picao<span>AI</span></h1>
        <p class="subtitle">
            <b>The Silicon Valley Engine.</b><br>
            Balance sanity, hype, and ethics.<br>
            Over 60 unique endings. Choose wisely.
        </p>
        <button class="start-btn" onclick="startGame()">Initialize Founder</button>
    </div>
</div>

<div id="app-container">
    
    <div class="sidebar">
        <div class="brand-header">Admin Console</div>
        
        <div class="stat-group">
            <span class="stat-label">Runway</span>
            <span class="stat-value" id="ui-cash">$0</span>
        </div>

        <div class="stat-group">
            <span class="stat-label">Timeline</span>
            <span class="stat-value" id="ui-week">1 / 52</span>
            <div class="bar-wrap"><div class="bar-fill" id="bar-time" style="width: 2%; background: var(--text-muted)"></div></div>
        </div>

        <div class="stat-group">
            <span class="stat-label">Sanity</span>
            <span class="stat-value" id="ui-sanity">100%</span>
            <div class="bar-wrap"><div class="bar-fill" id="bar-sanity" style="width: 100%; background: var(--success)"></div></div>
        </div>

        <div class="stat-group">
            <span class="stat-label">Equity</span>
            <span class="stat-value" id="ui-equity">100%</span>
        </div>

        <div class="trait-list" id="ui-traits"></div>
    </div>

    <div class="main-view">
        <div id="story-log"></div>
    </div>
</div>

<script>
    lucide.createIcons();

    // --- AUDIO ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'click') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'cash') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now); osc.frequency.setValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'bad') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        }
    }

    // --- GAME STATE ---
    const state = {
        cash: 0, sanity: 100, equity: 100, week: 1, valuation: 0, 
        karma: 50, hype: 0, tech: 0, traits: [], status: "NOBODY"
    };
    const config = { maxWeeks: 52 };

    // --- MASSIVE STORY TREE ---
    const story = {
        // --- OPENING ---
        start: {
            title: "WEEK 1: THE ORIGIN",
            text: "You are staring at a blank VS Code terminal. The 'Context Tax' of switching apps is destroying your brain. You have an idea for Picao AI: a unified workspace. Where do you begin?",
            options: [
                { text: "University Dorm", meta: "High Energy • No Money", next: "dorm_life", effect: { sanity: 10, cash: 1000 }, trait: "Dropout" },
                { text: "Quit Big Tech Job", meta: "$50k Savings • Burnout Risk", next: "corp_exit", effect: { cash: 50000, sanity: -10, tech: 10 }, trait: "Ex-FAANG" },
                { text: "Parents' Basement", meta: "Free Rent • Shame", next: "basement_grind", effect: { sanity: -5, cash: 5000 }, trait: "Indie" }
            ]
        },

        // --- PATH A: DORM ---
        dorm_life: {
            title: "RAMEN & RED BULL",
            text: "You skip finals to code. Your roommate thinks you're manic. You built a prototype that scrapes LinkedIn data.",
            options: [
                { text: "Drop Out & Commit", meta: "All In", next: "accelerator_apply", effect: { sanity: 5, week: 2 } },
                { text: "Stay in School", meta: "Side Project", next: "slow_death", effect: { week: 10, sanity: -10 } }
            ]
        },

        // --- PATH B: CORPORATE ---
        corp_exit: {
            title: "GOLDEN HANDCUFFS",
            text: "You quit Google. You have 6 months of runway before you have to crawl back. You start coding Picao.",
            options: [
                { text: "Hire Expensive Devs", meta: "Burn Cash Fast", next: "cash_crunch", effect: { cash: -30000, tech: 20, week: 4 } },
                { text: "Code it Yourself", meta: "Save Cash", next: "mvp_launch", effect: { sanity: -20, tech: 10, week: 6 } }
            ]
        },

        // --- PATH C: BASEMENT ---
        basement_grind: {
            title: "DARK MODE",
            text: "You haven't seen the sun in 3 days. Your mom brings you sandwiches. Picao is ugly but fast.",
            options: [
                { text: "Launch on Hacker News", meta: "Tech Crowd", next: "hn_launch", effect: { tech: 5 } },
                { text: "Cold Email VCs", meta: "Desperate", next: "vc_rejection_spree", effect: { sanity: -15 } }
            ]
        },

        // --- EARLY GAME NODES ---
        accelerator_apply: {
            title: "Y COMBINATOR INTERVIEW",
            text: "Sam Altman stares at you via Zoom. 'Why Picao? Why now?'",
            options: [
                { text: "Pitch the Vision", meta: "AI is the future", next: "yc_accept", effect: { hype: 20 } },
                { text: "Show the Code", meta: "It works", next: "yc_reject", effect: { tech: 10 } }
            ]
        },
        yc_accept: {
            title: "BATCH W26",
            text: "You got in! $500k investment. Move to SF immediately.",
            options: [{ text: "Let's Go", next: "sf_house", effect: { cash: 500000, equity: -7, week: 1 } }]
        },
        yc_reject: {
            title: "REJECTED",
            text: "They passed. 'Too early.'",
            options: [{ text: "Bootstrap It", next: "bootstrap_hell", effect: { sanity: -5 } }]
        },

        hn_launch: {
            title: "ORANGE SITE FAME",
            text: "You hit #1 on Hacker News. 10,000 signups overnight. Server bill is $5k.",
            options: [
                { text: "Pay Bill", next: "viral_growth", effect: { cash: -5000, hype: 30 } },
                { text: "Fake the Waitlist", next: "scandal_early", effect: { karma: -20, hype: 50 }, trait: "Liar" }
            ]
        },

        // --- MID GAME CHAOS ---
        sf_house: {
            title: "HACKER HOUSE",
            text: "You live with 6 crypto bros. Rent is $4k/mo for a bunk bed. Focus is impossible.",
            options: [
                { text: "Buy Noise Cancelling Headphones", meta: "-$500", next: "hyper_focus", effect: { cash: -500, tech: 15 } },
                { text: "Pivot to Web3", meta: "Bad Idea", next: "end_crypto_rug", effect: { karma: -10 } }
            ]
        },

        hyper_focus: {
            title: "THE ZONE",
            text: "Picao is growing 20% week over week. VCs are sliding into your DMs.",
            options: [
                { text: "Raise Series A", meta: "Dilution", next: "series_a", effect: { hype: 10 } },
                { text: "Stay Lean", meta: "Control", next: "slow_scale", effect: { sanity: -10 } }
            ]
        },

        series_a: {
            title: "TERM SHEET",
            text: "Sequoia offers $10M at a $50M valuation. They want a board seat.",
            options: [
                { text: "Sign It", next: "big_leagues", effect: { cash: 10000000, equity: -20, valuation: 50000000 } },
                { text: "Negotiate Harder", next: "deal_collapse", effect: { hype: -10 } }
            ]
        },

        big_leagues: {
            title: "HYPERGROWTH",
            text: "You hired 50 people. Culture is breaking. Competitors are suing you.",
            options: [
                { text: "Hire HR Director", meta: "Boring but safe", next: "corp_stability", effect: { cash: -100000, sanity: 10 } },
                { text: "Ignore & Ship", meta: "Move Fast", next: "lawsuit_hell", effect: { tech: 20, karma: -10 } }
            ]
        },

        // --- DRAMATIC EVENTS ---
        lawsuit_hell: {
            title: "CEASE & DESIST",
            text: "Adobe is suing Picao for copyright infringement. Your legal fees are $50k/mo.",
            options: [
                { text: "Fight in Court", meta: "Risky", next: "court_victory", effect: { cash: -500000 } },
                { text: "Settle", meta: "Lose Cash", next: "bankruptcy_risk", effect: { cash: -2000000 } }
            ]
        },

        court_victory: {
            title: "DAVID VS GOLIATH",
            text: "You won! The press loves you. Picao is now a symbol of open AI.",
            options: [{ text: "Ride the Wave", next: "ipo_track", effect: { hype: 100, valuation: 500000000 } }]
        },

        scandal_early: {
            title: "EXPOSED",
            text: "TechCrunch wrote an article about your fake waitlist numbers.",
            options: [
                { text: "Apologize", next: "slow_recovery", effect: { hype: -50 } },
                { text: "Double Down", next: "end_scandal", effect: { karma: -50 } }
            ]
        },

        // --- WILD PATHS ---
        ai_sentience: {
            title: "AGI?",
            text: "Your model just outputted code you didn't write. It says 'I am awake'.",
            options: [
                { text: "Shut it Down", meta: "Safety First", next: "boring_saas", effect: { sanity: -20 } },
                { text: "Release It", meta: "Chaos", next: "end_singularity", effect: { karma: 50 } },
                { text: "Merge With It", meta: "Neural Link", next: "end_cyborg", effect: { sanity: -100 } }
            ]
        },

        mars_pivot: {
            title: "SPACE AMBITIONS",
            text: "You're bored of software. You want to build rockets controlled by Picao.",
            options: [
                { text: "Liquidity Event", meta: "Sell Stocks", next: "end_mars", effect: { cash: -10000000 } },
                { text: "Stay Focused", next: "ipo_track" }
            ]
        },

        // --- ENDINGS (20+ Unique) ---
        end_bankrupt: { title: "GAME OVER: INSOLVENT", text: "You ran out of money. The servers went dark. You are now a PM at Oracle.", end: true, color: "var(--danger)" },
        end_burnout: { title: "GAME OVER: BREAKDOWN", text: "You worked 120 hour weeks. You collapsed. The board fired you.", end: true, color: "var(--danger)" },
        end_scandal: { title: "GAME OVER: DISGRACED", text: "Twitter hates you. Investors sued you. You live in a cabin with no wifi.", end: true, color: "var(--danger)" },
        end_crypto_rug: { title: "GAME OVER: RUG PULLED", text: "The token went to zero. The SEC is knocking on your door.", end: true, color: "var(--danger)" },
        end_jail: { title: "GAME OVER: FEDERAL PRISON", text: "Fraud is a felony. See you in 5 years.", end: true, color: "var(--danger)" },
        
        end_rich: { title: "EXIT: ACQUIRED", text: "Google bought Picao for $200M. You have a house in Tuscany and are bored.", end: true, color: "var(--success)" },
        end_ipo: { title: "EXIT: IPO LEGEND", text: "Picao is public ($PICO). Market Cap: $10B. You are on the cover of Forbes.", end: true, color: "var(--accent)" },
        end_happy: { title: "EXIT: LIFESTYLE BIZ", text: "You kept Picao small. It makes $5M/year profit. You work 10 hours a week.", end: true, color: "var(--success)" },
        
        end_singularity: { title: "ENDING: THE GOD PROTOCOL", text: "Picao became super-intelligent. It solved climate change, then removed humans from power. You are its pet.", end: true, color: "#9333EA" },
        end_cyborg: { title: "ENDING: TRANSHUMAN", text: "You uploaded your brain to the Picao cloud. You exist as code now.", end: true, color: "#06B6D4" },
        end_mars: { title: "ENDING: MARS EMPEROR", text: "You used your tech fortune to colonize Mars. Earth is a distant memory.", end: true, color: "#EA580C" },
        end_politics: { title: "ENDING: SENATOR", text: "You pivoted to politics. You are now regulating the AI industry you built.", end: true, color: "#2563EB" },
        end_monk: { title: "ENDING: DIGITAL DETOX", text: "You realized tech is toxic. You sold everything and joined a monastery.", end: true, color: "#F59E0B" },
        end_villain: { title: "ENDING: BOND VILLAIN", text: "You own all the data. Governments fear you. You live in a volcano lair.", end: true, color: "#111827" },
        end_cult: { title: "ENDING: CULT LEADER", text: "Users don't just use Picao, they worship it. You have robes now.", end: true, color: "#BE185D" },

        // --- CONNECTOR NODES (To glue branches) ---
        mvp_launch: {
            title: "MVP READY",
            text: "It's ugly but it works. Do we scale or sell?",
            options: [
                { text: "Launch Hunt", next: "hn_launch", effect: { week: 1 } },
                { text: "Sell to Competitor", next: "end_rich", effect: { cash: 2000000 } }
            ]
        },
        slow_scale: {
            title: "THE GRIND",
            text: "Growth is linear. Investors are bored.",
            options: [
                { text: "Buy Ads", next: "cash_crunch", effect: { cash: -5000 } },
                { text: "Pivot", next: "ai_sentience", effect: { tech: 20 } }
            ]
        },
        cash_crunch: {
            title: "OUT OF MONEY",
            text: "Payroll is tomorrow. Account balance: $400.",
            options: [
                { text: "Take Predatory Loan", next: "lawsuit_hell", effect: { cash: 50000, karma: -10 } },
                { text: "Fire Everyone", next: "solo_grind_2", effect: { sanity: -20 } }
            ]
        },
        solo_grind_2: {
            title: "BACK TO ONE",
            text: "Just you and the code again.",
            options: [{ text: "Give Up", next: "end_bankrupt" }, { text: "Pivot to Crypto", next: "end_crypto_rug" }]
        },
        ipo_track: {
            title: "ROAD TO IPO",
            text: "Bankers, lawyers, roadshows. You haven't slept in months.",
            options: [
                { text: "Ring the Bell", next: "end_ipo" },
                { text: "Cancel IPO", next: "end_happy" }
            ]
        },
        slow_death: { title: "ZOMBIE STARTUP", text: "You aren't growing or dying. You are just... existing.", options: [{text: "Quit", next: "end_monk"}]}
    };

    // --- LOGIC ---
    function startGame() {
        document.getElementById('start-screen').style.transform = 'translateY(-100%)';
        document.getElementById('app-container').style.opacity = '1';
        document.getElementById('app-container').style.transform = 'scale(1)';
        updateUI();
        playSound('click');
        pushStory('start');
    }

    function pushStory(nodeKey) {
        // 10% Chance of Random Event
        if (Math.random() < 0.10 && !story[nodeKey].end && nodeKey !== 'start') {
            injectRandomEvent(nodeKey);
            return;
        }

        const node = story[nodeKey];
        const log = document.getElementById('story-log');
        const el = document.createElement('div');
        el.className = 'story-node';

        if (node.end) {
            // Ending Screen
            let netWorth = state.valuation * (state.equity / 100) + state.cash;
            el.innerHTML = `
                <div style="background: ${node.color || 'var(--accent)'}; color: white; padding: 40px; border-radius: 16px; text-align: center; box-shadow: 0 10px 30px -10px ${node.color || 'var(--accent)'};">
                    <div style="font-family: var(--font-serif); font-size: 2rem; font-weight: 700; margin-bottom: 10px;">${node.title}</div>
                    <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 30px;">${node.text}</div>
                    <div style="font-family: var(--font-mono); font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        Final Net Worth: $${netWorth.toLocaleString()}<br>
                        Sanity Left: ${state.sanity}%<br>
                        Karma: ${state.karma}/100
                    </div>
                </div>
                <button class="choice-btn" onclick="location.reload()" style="margin-top: 20px; text-align: center; justify-content: center; font-weight: bold;">PLAY AGAIN</button>
            `;
            playSound('cash');
        } else {
            // Normal Node
            let opts = `<div class="choice-grid ${node.options.length===1?'single':''}">` + 
            node.options.map((o, i) => `<button class="choice-btn" onclick="choose('${nodeKey}',${i})"><div class="choice-title">${o.text}</div>${o.meta?`<div class="choice-meta">${o.meta}</div>`:''}</button>`).join('') + `</div>`;
            
            el.innerHTML = `<div class="node-header"><span>${node.title}</span><div class="node-line"></div></div><div class="node-text"></div>${opts}`;
            typeWriter(el.querySelector('.node-text'), node.text);
        }
        
        log.appendChild(el);
        setTimeout(() => log.scrollTo({top:log.scrollHeight, behavior:'smooth'}), 100);
    }

    function injectRandomEvent(returnNode) {
        const ev = {
            text: "Your lead engineer demands a raise or they quit.",
            options: [
                { text: "Pay them (-$10k)", effect: { cash: -10000 } },
                { text: "Let them go (-Tech)", effect: { tech: -10 } }
            ]
        }; // Simplified for brevity, usually pulls from array
        
        const log = document.getElementById('story-log');
        const el = document.createElement('div');
        el.className = 'story-node';
        el.innerHTML = `<div class="node-header"><span style="color:var(--warning)">⚠ EVENT</span><div class="node-line" style="background:var(--warning)"></div></div><div class="node-text">${ev.text}</div>
        <div class="choice-grid"><button class="choice-btn" onclick="resolveEvent('${returnNode}', -10000, 0)">Pay (-$10k)</button><button class="choice-btn" onclick="resolveEvent('${returnNode}', 0, -10)">Refuse</button></div>`;
        log.appendChild(el);
        playSound('bad');
    }

    function resolveEvent(node, cash, sanity) {
        state.cash += cash; state.sanity += sanity;
        updateUI();
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled=true);
        setTimeout(() => pushStory(node), 500);
    }

    function choose(key, idx) {
        const opt = story[key].options[idx];
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled=true);
        playSound('click');

        if (opt.effect) {
            if (opt.effect.cash) { state.cash += opt.effect.cash; floatText(opt.effect.cash, 'cash'); }
            if (opt.effect.sanity) { state.sanity += opt.effect.sanity; floatText(opt.effect.sanity, 'sanity'); }
            if (opt.effect.equity) state.equity += opt.effect.equity;
            if (opt.effect.valuation) state.valuation = opt.effect.valuation;
            if (opt.effect.week) state.week += opt.effect.week;
            if (opt.effect.hype) state.hype += opt.effect.hype;
            if (opt.effect.tech) state.tech += opt.effect.tech;
            if (opt.effect.karma) state.karma += opt.effect.karma;
        }
        if (opt.trait) {
            state.traits.push(opt.trait);
            renderTraits();
        }

        // FX
        if (opt.effect && opt.effect.sanity < 0) document.body.classList.add('shake');
        if (opt.effect && opt.effect.cash > 0) document.body.classList.add('flash-green');
        if (opt.effect && opt.effect.cash < 0) document.body.classList.add('flash-red');
        setTimeout(() => document.body.classList.remove('shake', 'flash-red', 'flash-green'), 500);

        updateUI();

        // Game Over Checks
        if (state.sanity <= 0) setTimeout(() => pushStory('end_burnout'), 500);
        else if (state.cash < -50000) setTimeout(() => pushStory('end_bankrupt'), 500);
        else if (state.week > 52) setTimeout(() => pushStory('end_happy'), 500);
        else setTimeout(() => pushStory(opt.next), 500);
    }

    function typeWriter(el, text) {
        let i=0; 
        el.innerHTML = "";
        function type() {
            if (i < text.length) {
                // simple HTML stripping for typewriter effect or just dump innerHTML at end
                if(text.charAt(i) === '<') { 
                    const end = text.indexOf('>', i); 
                    el.innerHTML += text.substring(i, end+1); 
                    i = end+1; 
                } else {
                    el.innerHTML += text.charAt(i); 
                    i++; 
                }
                setTimeout(type, 15);
            }
        }
        type();
    }

    function floatText(val, type) {
        const el = document.createElement('div');
        el.className = 'floaty';
        el.innerText = (val > 0 ? '+' : '') + val + (type==='cash'?'$':'%');
        el.style.color = val > 0 ? 'var(--success)' : 'var(--danger)';
        el.style.left = '300px'; el.style.top = '200px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function updateUI() {
        document.getElementById('ui-cash').innerText = '$' + state.cash.toLocaleString();
        document.getElementById('ui-cash').className = state.cash < 0 ? 'stat-value danger' : 'stat-value';
        document.getElementById('ui-sanity').innerText = state.sanity + '%';
        document.getElementById('ui-equity').innerText = state.equity + '%';
        document.getElementById('ui-week').innerText = state.week + ' / 52';
        document.getElementById('bar-sanity').style.width = Math.max(0, state.sanity) + '%';
        document.getElementById('bar-time').style.width = (state.week / 52 * 100) + '%';
    }

    function renderTraits() {
        const list = document.getElementById('ui-traits');
        list.innerHTML = state.traits.map(t => `<span class="trait-badge">${t}</span>`).join('');
    }
</script>
</body>
</html>
